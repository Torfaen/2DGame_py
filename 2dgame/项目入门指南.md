# 泡泡堂游戏项目 - 入门指南

## 📚 目录
1. [项目概述](#项目概述)
2. [如何运行项目](#如何运行项目)
3. [项目结构说明](#项目结构说明)
4. [核心概念解释](#核心概念解释)
5. [主要代码文件说明](#主要代码文件说明)
6. [常见问题解答](#常见问题解答)

---

## 项目概述

这是一个**类似泡泡堂的2D对战游戏**，使用Python和Pygame库开发。

### 游戏玩法
- 两个玩家在地图上移动
- 玩家可以放置炸弹（泡泡）
- 炸弹会在几秒后爆炸，炸毁障碍物
- 被炸死的玩家输掉游戏
- 炸毁障碍物有机会掉落道具，增强玩家能力

### 技术栈
- **Python**: 编程语言
- **Pygame**: 游戏开发库（处理图形、声音、输入等）
- **YAML**: 配置文件格式（存储游戏设置）

---

## 如何运行项目

### 前置要求
1. 安装Python（建议3.7以上版本）
2. 安装Pygame库：
   ```bash
   pip install pygame pyyaml
   ```

### 运行步骤
1. 打开终端（命令行）
2. 进入项目目录：
   ```bash
   cd 2dgame/src
   ```
3. 运行游戏：
   ```bash
   python game_manager.py
   ```
   或者运行旧版本：
   ```bash
   python main.py
   ```

### 操作说明
- **玩家1**（红方块/角色）：
  - 方向键（↑↓←→）移动
  - 右Shift键放置炸弹

- **玩家2**（另一个角色）：
  - WASD键移动
  - 左Shift键放置炸弹

- **调试模式**：
  - 按数字键 `1` 开启/关闭调试模式（显示碰撞框、坐标等）

---

## 项目结构说明

```
2dgame/
├── src/                    # 源代码目录
│   ├── main.py            # 旧版游戏入口（简单版本）
│   ├── game_manager.py    # 新版游戏入口（完整版本，推荐使用）
│   ├── player.py          # 玩家类（控制角色移动、放置炸弹等）
│   ├── map.py             # 地图类（管理地图绘制、碰撞检测等）
│   ├── bomb.py            # 炸弹类（管理炸弹状态、爆炸时间等）
│   ├── explosion.py       # 爆炸类（管理爆炸效果、范围等）
│   ├── item.py            # 道具类（管理道具生成、效果等）
│   ├── audio_manager.py   # 音频管理器（管理背景音乐、音效）
│   ├── config_loader.py   # 配置加载器（读取YAML配置文件）
│   └── util.py            # 工具函数（辅助功能）
│
├── config/                 # 配置文件目录
│   ├── config.yaml        # 主配置文件（窗口大小、游戏模式等）
│   ├── config_player.yaml # 玩家配置（出生点、按键设置）
│   ├── config_character.yaml # 角色属性（速度、炸弹数量等）
│   ├── config_tile.yaml   # 地图物块配置（贴图路径、碰撞属性）
│   ├── config_items.yaml  # 道具配置（道具类型、效果）
│   └── config_sprite.yaml # 角色贴图配置
│
├── assets/                 # 资源文件目录
│   ├── sprites/           # 图片资源
│   │   ├── player/        # 玩家角色贴图
│   │   ├── bomb/          # 炸弹贴图
│   │   ├── items/         # 道具贴图
│   │   └── background/    # 背景和地图贴图
│   └── audio/             # 音频资源
│       ├── bgm/           # 背景音乐
│       └── Sound effect/  # 音效
│
└── map/                    # 地图数据目录
    ├── floor_map.json     # 地板层数据
    ├── barrier_map.json   # 障碍物层数据
    └── collision_map.json # 碰撞层数据
```

---

## 核心概念解释

### 1. 游戏循环
游戏每秒钟会执行60次（60 FPS），每次循环包括：
- **输入处理**：检测玩家按键
- **游戏逻辑更新**：更新玩家位置、炸弹倒计时、爆炸效果等
- **渲染**：将画面绘制到屏幕上

### 2. 地图系统（三层结构）
游戏地图由三层组成：
- **地板层（floor_map）**：最底层，显示地面
- **障碍物层（barrier_map）**：中间层，显示可破坏的障碍物（如箱子）
- **碰撞层（collision_map）**：逻辑层，标记哪些地方不能通过
  - `0` = 可以通行
  - `1` = 可摧毁的障碍物
  - `2` = 不可摧毁的障碍物（如墙壁）

### 3. 坐标系统
- **像素坐标**：屏幕上的实际位置（x, y）
- **格子坐标**：地图按32x32像素分成格子，用（grid_x, grid_y）表示
- **锚点**：角色的脚部位置，用于判断角色在哪个格子上

### 4. 碰撞检测
- 玩家移动时，检查是否与障碍物碰撞
- 如果碰撞，玩家不能继续移动
- 使用**矩形碰撞**（rect）来判断两个物体是否重叠

### 5. 爆炸系统
- 炸弹放置后，3.5秒后爆炸
- 爆炸会向上下左右四个方向扩散
- 扩散范围由炸弹的`power`（威力）决定
- 遇到不可摧毁的障碍物会停止扩散

### 6. 道具系统
- 炸毁障碍物时，有30%概率掉落道具
- 道具类型：
  - 速度提升（speed_up）
  - 炸弹数量增加（bomb_count_up）
  - 炸弹威力增加（bomb_power_up）
  - 速度最大化（speed_max）
  - 炸弹数量最大化（bomb_count_max）
  - 炸弹威力最大化（bomb_power_max）

---

## 主要代码文件说明

### 1. `game_manager.py` - 游戏管理器（核心文件）

**作用**：游戏的"大脑"，管理整个游戏流程

**主要功能**：
- `init()`: 初始化游戏（创建窗口、加载地图、创建玩家）
- `run()`: 主游戏循环
- `update()`: 更新游戏状态（玩家移动、炸弹倒计时、爆炸处理等）
- `_render()`: 绘制画面

**关键执行顺序**：
```
输入 → 更新 → 碰撞/爆炸 → 伤害 → 渲染
```

**重要方法**：
- `_update_player()`: 更新玩家状态（移动、放置炸弹）
- `_update_bomb()`: 更新炸弹状态（倒计时、爆炸）
- `_update_explosion()`: 处理爆炸效果（摧毁障碍物、伤害玩家）
- `_update_item()`: 处理道具拾取

---

### 2. `player.py` - 玩家类

**作用**：管理单个玩家的所有行为

**主要属性**：
- `id`: 玩家ID（1或2）
- `speed`: 移动速度
- `bombs_count`: 最多可同时放置的炸弹数量
- `bomb_power`: 炸弹威力（爆炸范围）
- `rect`: 玩家在屏幕上的位置和大小
- `feet_rect`: 玩家脚部锚点（用于判断在哪个格子）

**主要方法**：
- `handle_input()`: 处理键盘输入，返回移动方向（dx, dy）
- `move()`: 移动玩家，并检测碰撞
- `place_bomb()`: 放置炸弹（需要冷却时间）
- `hit_by_bomb()`: 被炸弹炸到时调用
- `update_item_effect()`: 拾取道具后更新属性

**关键概念**：
- **冷却时间（cooldown）**：放置炸弹后需要等待一段时间才能再放
- **动画帧**：角色移动时播放动画，通过切换图片实现

---

### 3. `map.py` - 地图类

**作用**：管理地图的绘制和碰撞检测

**主要属性**：
- `floor_map`: 地板层数据（二维数组）
- `barrier_map`: 障碍物层数据（二维数组）
- `collision_map`: 碰撞层数据（二维数组）
- `collision_rects`: 所有碰撞框的列表
- `tiles`: 存储所有贴图图片的字典

**主要方法**：
- `draw_floor()`: 绘制地板层
- `draw_tile()`: 绘制单个物块
- `remove_barrier()`: 移除障碍物（被炸弹炸毁时调用）
- `remove_collision()`: 移除碰撞框（炸弹爆炸后移除）

**关键概念**：
- **绘制顺序**：按角色的Y坐标（底部位置）排序，实现正确的遮挡关系
- **贴图加载**：从`config_tile.yaml`读取配置，自动加载所有贴图

---

### 4. `bomb.py` - 炸弹类

**作用**：管理单个炸弹的状态

**主要属性**：
- `timer`: 炸弹倒计时
- `exploded`: 是否已爆炸
- `power`: 爆炸威力（扩散范围）
- `alive`: 炸弹是否还存在

**主要方法**：
- `update()`: 更新炸弹状态（倒计时、动画）
- `_update_bomb_status()`: 检查是否到爆炸时间（3.5秒）

**关键逻辑**：
- 炸弹放置后开始倒计时
- 倒计时结束后，`exploded`变为`True`
- 游戏管理器检测到`exploded=True`后，创建爆炸对象

---

### 5. `item.py` - 道具类

**作用**：管理游戏中的道具

**主要属性**：
- `name`: 道具名称
- `effect_type`: 效果类型（speed/bomb_count/bomb_power等）
- `effect_value`: 效果数值（增加多少）

**主要方法**：
- `create_random()`: 随机生成一个道具
- `get_effect()`: 返回道具效果（字典格式）

**关键逻辑**：
- 道具被玩家拾取后，调用玩家的`update_item_effect()`方法
- 玩家属性相应增加（速度、炸弹数量、威力等）

---

### 6. `config_loader.py` - 配置加载器

**作用**：读取YAML配置文件

**主要函数**：
- `load_config()`: 加载YAML配置文件，返回字典
- `dict_controls()`: 将按键字符串（如"K_w"）转换为Pygame常量（pygame.K_w）

**为什么需要配置文件？**
- 方便修改游戏参数（速度、窗口大小等）而不需要改代码
- 便于多人协作，各自配置不同设置

---

## 常见问题解答

### Q1: 游戏无法启动？
**A**: 检查以下几点：
1. 是否安装了Pygame：`pip install pygame pyyaml`
2. 是否在正确的目录运行：`cd 2dgame/src`
3. 检查配置文件是否存在：`config/config.yaml`

### Q2: 如何修改玩家速度？
**A**: 修改 `config/config_character.yaml` 文件中的 `speed` 值

### Q3: 如何修改窗口大小？
**A**: 修改 `config/config.yaml` 文件中的 `windows.window.width` 和 `height`

### Q4: 如何添加新角色？
**A**: 
1. 在 `assets/sprites/player/` 添加角色贴图
2. 在 `config/config_character.yaml` 添加角色配置
3. 在 `config/config_sprite.yaml` 添加贴图配置

### Q5: 如何修改地图？
**A**: 修改 `map/` 目录下的JSON文件：
- `floor_map.json`: 地板层
- `barrier_map.json`: 障碍物层
- `collision_map.json`: 碰撞层

### Q6: 调试模式有什么用？
**A**: 按数字键`1`开启调试模式，会显示：
- 绿色框：玩家碰撞框
- 蓝色框：地图碰撞框
- 坐标信息：帮助理解位置关系

### Q7: 炸弹爆炸范围如何计算？
**A**: 炸弹会向上下左右四个方向扩散，每个方向扩散`power`格。遇到不可摧毁的障碍物会停止。

### Q8: 为什么有时候放不了炸弹？
**A**: 可能原因：
1. 冷却时间未到（刚放下炸弹后需要等待0.25秒）
2. 已达到最大炸弹数量限制
3. 当前位置已有炸弹

### Q9: 道具如何生成？
**A**: 炸毁障碍物时，有30%概率掉落随机道具。道具类型在`config/config_items.yaml`中配置。

### Q10: 如何添加新道具？
**A**: 
1. 在 `config/config_items.yaml` 添加道具配置
2. 在 `assets/sprites/items/` 添加道具贴图
3. 道具效果在`player.py`的`update_item_effect()`方法中处理

---

## 学习建议

### 对于初学者：
1. **先运行游戏**，熟悉操作和玩法
2. **开启调试模式**，观察碰撞框和坐标
3. **修改配置文件**，看看效果如何变化
4. **阅读代码**，从`game_manager.py`开始，理解游戏循环
5. **尝试小修改**，比如改变玩家速度、炸弹爆炸时间等

### 理解代码的顺序建议：
1. `config.yaml` → 了解游戏基本配置
2. `game_manager.py` → 理解游戏主循环
3. `player.py` → 理解玩家如何移动和放置炸弹
4. `bomb.py` → 理解炸弹如何工作
5. `map.py` → 理解地图如何绘制和碰撞检测

### 调试技巧：
- 使用`print()`语句输出变量值，帮助理解程序流程
- 开启调试模式观察碰撞框
- 修改配置文件测试不同效果

---

## 总结

这个项目是一个完整的2D游戏，包含了：
- ✅ 玩家控制系统
- ✅ 地图系统和碰撞检测
- ✅ 炸弹和爆炸系统
- ✅ 道具系统
- ✅ 音效系统
- ✅ 配置文件系统

**核心思想**：游戏每帧都在"输入→更新→渲染"的循环中运行，通过不断更新游戏状态和重绘画面，实现动态的游戏效果。

祝你学习愉快！🎮

